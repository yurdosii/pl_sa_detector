# pl_sa_detector
An API to detect political leaning (Pro-Ukrainian or Pro-Russian) and sentiment (Positive, Neutral, Negative) of the text message

Note: more info can be found on `api_service` and `ml_service` `README.md` files

---
## ML models
To detect the political leaning and sentiment of the text, 2 machine learning models were used.

They were implemented as part of the master diploma research where machine learning algorithms, neural networks, ensembles of models and different vectorization and imbalanced data techniques were applied.

As a result, the prediction of the text's political leaning involved Logistic Regression with TF-IDF vectorization, whereas, for sentiment analysis, LinearSVC and TF-IDF vectorization were used. More info can be found in this [repository](https://github.com/yurdosii/pl_sa_diploma).

---
## Running
### To run using docker-compose:
```
docker-compose build
docker-compose up
```

After this go to `http://127.0.0.1:8001/docs/` and `http://127.0.0.1:8002/docs/`.

---
## Running a particular service
### To run locally
```
cd api_service  # or 'cd ml_service'
poetry run uvicorn src.main:app --reload
```

### To run via Docker
- to use `ml_service` just replace `pl_sa_detector_api_service` to `pl_sa_detector_ml_service`
```
docker build -t pl_sa_detector_api_service .
docker run -p 8000:8000 pl_sa_detector_api_service
```

---
## Development
### initial
```
cd api_service
poetry install
poetry shell  # or 'source .venv/bin/activate'
```

### linters / tests
- run linters and tests via `tox`:
```
tox
```
- or run them manually:
```
make lint
pytest
```

### make / apply migration
```
alembic revision --autogenerate -m "migration name"
alembic upgrade head
```

---

## Known issues
### scipy installation
Problem description:
```
ERROR: Dependency "OpenBLAS" not found, tried pkgconfig and framework
```
Fix (set env variables):
```
export LDFLAGS="-L/opt/homebrew/opt/openblas/lib"
export CPPFLAGS="-I/opt/homebrew/opt/openblas/include"
export PKG_CONFIG_PATH="/opt/homebrew/opt/openblas/lib/pkgconfig"
```
### tox skips Python 3.10
Description:
- for some reason `tox` may skipp Python 3.10

Solution:
- try to remove `.tox`
- try to enable Python 3.10 via `pyenv`
```
poetry run tox  # may be skipping here
pyenv install 3.10
pyenv versions
pyenv global 3.10.11
poetry run tox  # Python 3.10 should be working
pyenv global 3.11.3  # set back
poetry run tox  # Python 3.10 should be working
```

---
## Debugging

### Debugging of a particular service using Docker / Dockerfile
- note: to use `ml_service` just replace `api_service` -> `ml_service`, `pl_sa_detector_api_service` -> `pl_sa_detector_ml_service`
1. set `breakpoint()` somewhere
2. run the app like:
```
cd `api_service`
docker build -t pl_sa_detector_api_service .
docker run -p 8000:8000 -it --rm pl_sa_detector_api_service
```

### Debugging w/ docker-compose
- to be able to use `breakpoint()` in a service
```
docker-compose build
docker-compose up
docker-compose run -p 8000:8000 --rm compose_ml_service
```

---
### To debug in VS Code locally
note: `.vscode/launch.json` is used for this. It was generated by "Run and Debug" -> "Add configuration" -> "Python" -> "FastAPI", after this manually updated to have `--reload`)

Steps:
- open `ml_service` folder in VS Code
- set Python interpreter to `.venv/bin/python`
- (optional) It could be necessary to re-create venv in the new terminal (`poetry shell`, `poetry install`)
- click "Start Debugging" / F5  in the "Run and Debug" section of VS Code

---

### To debug in VS Code in docker container
note: same as in "To debug in VS Code locally" `.vscode/launch.json` is used here, but on the last step I've updated the port to be 8005

Steps:
- open `pl_sa_detector` folder
- click on the green icon (Dev Containers [link](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)) -> "Reopen in Container" -> "from `docker-compose.yml`"
- (optional) It could be necessary to do this couple of times
- open `/code` folder (created on docker container by `Dockerfile` and `docker-compose.yml`)
- (optional) It could be necessary to install Python extension (there will be a pop-up)
- click "Start Debugging" / F5  in the "Run and Debug" section of VS Code

So we ran one docker container (8002 port (docker-compose)) with the server (FastAPI app). Then we connected to that docker container and ran another server on it (8005 port) that we can debug now (set breakpoints in VS Code)